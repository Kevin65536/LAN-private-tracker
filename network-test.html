<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT站网络连接测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .status {
            font-weight: bold;
            margin-left: 10px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .loading { color: #007bff; }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        #logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 PT站网络连接诊断工具</h1>
        <p>这个工具将帮助诊断为什么无法访问 PT站服务器</p>
        
        <div class="test-item">
            <h3>🌐 基础连接测试</h3>
            <div>目标服务器: <strong>172.21.134.69</strong></div>
            <button class="btn" onclick="testBasicConnection()">开始测试</button>
            <div id="basic-status" class="status"></div>
        </div>

        <div class="test-item">
            <h3>🔌 端口连通性测试</h3>
            <button class="btn" onclick="testPorts()">测试端口</button>
            <div id="port-status" class="status"></div>
        </div>

        <div class="test-item">
            <h3>🌍 HTTP服务测试</h3>
            <button class="btn" onclick="testHttpServices()">测试HTTP</button>
            <div id="http-status" class="status"></div>
        </div>

        <div class="test-item">
            <h3>📊 浏览器信息</h3>
            <div id="browser-info"></div>
        </div>

        <div class="test-item">
            <h3>🔧 快速修复</h3>
            <button class="btn" onclick="showFixSuggestions()">显示修复建议</button>
            <div id="fix-suggestions"></div>
        </div>

        <h3>📋 诊断日志</h3>
        <div id="logs"></div>
        
        <button class="btn" onclick="clearLogs()">清空日志</button>
        <button class="btn" onclick="exportLogs()">导出日志</button>
    </div>

    <script>
        const TARGET_IP = '172.21.134.69';
        const FRONTEND_PORT = 3000;
        const BACKEND_PORT = 3001;
        
        let logs = '';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': '[INFO]',
                'success': '[SUCCESS]', 
                'error': '[ERROR]',
                'warning': '[WARNING]'
            }[type] || '[INFO]';
            
            const logMessage = `${timestamp} ${prefix} ${message}\n`;
            logs += logMessage;
            document.getElementById('logs').textContent = logs;
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        function clearLogs() {
            logs = '';
            document.getElementById('logs').textContent = '';
        }

        function exportLogs() {
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pt-site-diagnosis-${new Date().toISOString().substr(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function testBasicConnection() {
            log('开始基础连接测试...');
            updateStatus('basic-status', '测试中...', 'loading');

            try {
                // 测试是否能加载一个简单的图片来验证网络
                const img = new Image();
                img.onload = () => {
                    log('网络连接正常', 'success');
                    updateStatus('basic-status', '✅ 网络连接正常', 'success');
                };
                img.onerror = () => {
                    log('网络连接异常', 'error');
                    updateStatus('basic-status', '❌ 网络连接异常', 'error');
                };
                img.src = `http://${TARGET_IP}:${FRONTEND_PORT}/favicon.ico?t=${Date.now()}`;
                
                // 超时处理
                setTimeout(() => {
                    if (document.getElementById('basic-status').textContent.includes('测试中')) {
                        log('连接测试超时', 'warning');
                        updateStatus('basic-status', '⚠️ 连接超时', 'warning');
                    }
                }, 5000);
                
            } catch (error) {
                log(`连接测试失败: ${error.message}`, 'error');
                updateStatus('basic-status', '❌ 连接失败', 'error');
            }
        }

        async function testPorts() {
            log('开始端口连通性测试...');
            updateStatus('port-status', '测试中...', 'loading');

            const ports = [
                { port: FRONTEND_PORT, name: '前端' },
                { port: BACKEND_PORT, name: '后端API' }
            ];

            let results = [];
            
            for (const portInfo of ports) {
                try {
                    log(`测试端口 ${portInfo.port} (${portInfo.name})...`);
                    
                    const response = await fetch(`http://${TARGET_IP}:${portInfo.port}/`, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    
                    results.push(`✅ ${portInfo.name}端口 ${portInfo.port} 可达`);
                    log(`端口 ${portInfo.port} 测试成功`, 'success');
                    
                } catch (error) {
                    results.push(`❌ ${portInfo.name}端口 ${portInfo.port} 不可达`);
                    log(`端口 ${portInfo.port} 测试失败: ${error.message}`, 'error');
                }
            }

            updateStatus('port-status', results.join(' | '), results.some(r => r.includes('❌')) ? 'error' : 'success');
        }

        async function testHttpServices() {
            log('开始HTTP服务测试...');
            updateStatus('http-status', '测试中...', 'loading');

            const services = [
                { url: `http://${TARGET_IP}:${FRONTEND_PORT}/`, name: '前端页面' },
                { url: `http://${TARGET_IP}:${BACKEND_PORT}/health`, name: '后端API' }
            ];

            let results = [];

            for (const service of services) {
                try {
                    log(`测试 ${service.name}: ${service.url}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(service.url, {
                        signal: controller.signal,
                        mode: 'cors'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        results.push(`✅ ${service.name} 正常 (${response.status})`);
                        log(`${service.name} 响应正常: HTTP ${response.status}`, 'success');
                    } else {
                        results.push(`⚠️ ${service.name} 异常 (${response.status})`);
                        log(`${service.name} 响应异常: HTTP ${response.status}`, 'warning');
                    }
                    
                } catch (error) {
                    results.push(`❌ ${service.name} 失败`);
                    log(`${service.name} 请求失败: ${error.message}`, 'error');
                }
            }

            updateStatus('http-status', results.join(' | '), results.some(r => r.includes('❌')) ? 'error' : 'success');
        }

        function showBrowserInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                '浏览器': navigator.appName,
                '版本': navigator.appVersion,
                '平台': navigator.platform,
                '语言': navigator.language,
                'Cookie启用': navigator.cookieEnabled,
                '在线状态': navigator.onLine,
                '当前URL': window.location.href,
                '协议': window.location.protocol,
                '主机': window.location.host
            };

            let infoHtml = '<table style="width:100%; font-size:12px;">';
            for (const [key, value] of Object.entries(info)) {
                infoHtml += `<tr><td style="font-weight:bold; padding:2px;">${key}:</td><td style="padding:2px;">${value}</td></tr>`;
            }
            infoHtml += '</table>';

            document.getElementById('browser-info').innerHTML = infoHtml;
            log('浏览器信息已显示');
        }

        function showFixSuggestions() {
            const suggestions = `
                <div style="font-size: 14px; line-height: 1.6;">
                    <h4>🔧 常见问题解决方案：</h4>
                    <ol>
                        <li><strong>清除浏览器缓存</strong><br>
                            按 Ctrl+Shift+Delete，清除浏览器缓存和Cookie</li>
                        <li><strong>禁用代理设置</strong><br>
                            浏览器设置 → 高级 → 系统 → 关闭代理服务器</li>
                        <li><strong>尝试其他浏览器</strong><br>
                            使用 Chrome、Firefox、Edge 等不同浏览器测试</li>
                        <li><strong>检查防火墙</strong><br>
                            暂时关闭 Windows Defender 防火墙测试</li>
                        <li><strong>刷新网络连接</strong><br>
                            禁用并重新启用网络适配器</li>
                        <li><strong>使用命令行测试</strong><br>
                            运行: curl http://${TARGET_IP}:${FRONTEND_PORT}</li>
                    </ol>
                    
                    <h4>🔍 详细诊断步骤：</h4>
                    <ol>
                        <li>按 F12 打开开发者工具</li>
                        <li>切换到 Network(网络) 标签页</li>
                        <li>勾选 "Preserve log"</li>
                        <li>刷新页面并观察失败的请求</li>
                        <li>点击失败的请求查看详细错误信息</li>
                    </ol>
                </div>
            `;
            
            document.getElementById('fix-suggestions').innerHTML = suggestions;
            log('修复建议已显示');
        }

        // 页面加载时自动显示浏览器信息
        window.onload = function() {
            log('PT站网络诊断工具已启动');
            log(`目标服务器: ${TARGET_IP}`);
            log(`前端端口: ${FRONTEND_PORT}`);
            log(`后端端口: ${BACKEND_PORT}`);
            showBrowserInfo();
        };

        // 监听网络状态变化
        window.addEventListener('online', () => {
            log('网络连接已恢复', 'success');
        });

        window.addEventListener('offline', () => {
            log('网络连接已断开', 'error');
        });
    </script>
</body>
</html>
